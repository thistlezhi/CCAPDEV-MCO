<!DOCTYPE html>
<html>
<head>
  <title>Reserve Slot</title>
  <link rel="stylesheet" href="css/style.css">
</head>
<body>

<h2>Reserve a Slot</h2>
<form id="reservationForm">
  <label for = "lab-Select">Lab:</label>

  <select class="lab-select" id="labSelect">
    <option value = "1">Gokongwei Lab</option>
    <option value = "2">Velasco Lab</option>
    <option value = "3">Andrew Lab</option>
    <option value = "4">St. La Salle Lab</option>
  </select>

<label for="date-select">Date:</label>
<input type="date" id="dateSelect" class="date-select">

<label for="time-select">Time:</label>
<select class ="time-select" id="timeSelect">
  <option value = "9:00">09:00</option>
  <option value = "9:30">09:30</option>
  <option value = "10:00">10:00</option>
</select>

<label>
  <input type="checkbox" id="anonymous">
  Reserve Anonymously
</label>

<button type="submit" id="confirmBtn">Confirm Reservation</button>
</form>
<a href="home.html">Back to Home Page</a>
<script src="js/data.js"></script>
<!---Date restriction script--->
  <script>
  const dateInput = document.getElementById('dateSelect');
  
  // Date today
  const today = new Date();
  const minDate = today.toISOString().split('T')[0];
  
  // Date 7 days from now
  const maxDate = new Date(today);
  maxDate.setDate(maxDate.getDate() + 7);
  const maxDateString = maxDate.toISOString().split('T')[0];
  
  // Restriction for today and next 7 days
  dateInput.setAttribute('min', minDate);
  dateInput.setAttribute('max', maxDateString);
  
  // Optionally set today as the default selected date
  dateInput.value = minDate;
</script>
<!---Main reservation Script --->
<script>
  document.getElementById('reservationForm').addEventListener('submit', function(event){
    event.preventDefault();
    //GET CURRENT USER
    const loggedUser = JSON.parse(localStorage.getItem('loggedInUser'));
    if(!loggedUser){
      alert('Please log in to make a reservation.');
      window.location.href = 'login.html';
      return;
    };

    //1. Get values from the form
    const labSelect = parseInt(document.getElementById('labSelect').value);
    const dateSelect = document.getElementById('dateSelect').value;
    const timeSelect = document.getElementById('timeSelect').value;
    const anonymous = document.getElementById('anonymous').checked;
    //2. Find Lab
    const lab = labs.find(l => l.id === labSelect);
    //3. Find seat
    // Filter reservations for the selected lab, date, and time
    const occupied = reservations.filter(r => r.labId === labSelect && r.date === dateSelect 
    && r.time === timeSelect).map(r => r.seat);

    let availableSeats = [];
    for(let i = 1; i <= lab.seats; i++){
      if(!occupied.includes(i)){
        availableSeats.push(i);
      }
    }

    if(availableSeats.length === 0){
      alert('No available seats for this slot. Please choose another time or date.');
      return;
    }
    if(availableSeats){
      //4. Create reservation object
      const newRes = {
        id: reservations.length + 1,
        userId: loggedUser.id,
        labId: labSelect,
        seat: availableSeats[0],
        date: dateSelect,
        time: timeSelect,
        anonymous: anonymous,
        dateRequested:  new Date().toISOString().slice(0,16).replace('T',' ')
      };
      //5. Push new reservation to reservation array
      reservations.push(newRes);
      //6. Save to local storage
      localStorage.setItem('reservations', JSON.stringify(reservations));
      //7. Alert success and reset form
      alert('Reservation successful! Your seat number is ' + availableSeats[0]);
      document.getElementById('reservationForm').reset(); 
    }else{
      alert('No available seats for this slot. Please choose another time or date.');
    }

  });
</script>

</body>
</html>
