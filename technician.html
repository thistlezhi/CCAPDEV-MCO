<!DOCTYPE html>
<html>
  <head>
    <title>Technician Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
  
  <div class="container">
    <div class="technician">
      <div>
        <div class="headertext">Technician Controls</div>
        <button onclick="openWalkinModal()">Reserve for Walk-in</button>
      </div>
      <div>
        <div class="headertext">All Reservations</div>
        <div class="tablescroll">
          <table id="techTable">
            <tr>
              <th>User</th>
              <th>Lab</th>
              <th>Seat</th>
              <th>Date</th>
              <th>Time</th>
              <th>Date Requested</th>
              <th>Actions</th>
            </tr>
          </table>
        </div>
      </div>
      
      
      
      <!-- Edit Reservation Modal -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Edit Reservation</h2>
            <button class="close-btn" onclick="closeEditModal()">&times;</button>
          </div>
          <form class="modal-form" id="editForm">
            <div class="form-group">
              <label for="editUser">User:</label>
              <input type="text" id="editUser" disabled>
            </div>
            <div class="form-group">
              <label for="editLab">Lab:</label>
              <select id="editLab" required>
                <option>Loading labs...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="editDate">Date:</label>
              <input type="date" id="editDate" required>
            </div>
            <div class="form-group">
              <label for="editTime">Time:</label>
              <input type="time" id="editTime" required>
            </div>
            <div class="form-group">
              <label for="editSeat">Seat:</label>
              <input type="number" id="editSeat" required min="1">
            </div>
            <div class="modal-actions">
              <button type="button" class="cancel-btn" onclick="closeEditModal()">Cancel</button>
              <button type="submit" class="save-btn">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
      
      
      
      <!-- Walk-in Reservation Modal -->
      <div id="walkinModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>Reserve for Walk-in</h2>
            <button class="close-btn" onclick="closeWalkinModal()">&times;</button>
          </div>
          <form class="modal-form" id="walkinForm">
            <div class="form-group">
              <label for="walkinStudent">Student:</label>
              <select id="walkinStudent" required>
                <option>Loading students...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="walkinLab">Lab:</label>
              <select id="walkinLab" required>
                <option>Loading labs...</option>
              </select>
            </div>
            <div class="form-group">
              <label for="walkinDate">Date:</label>
              <input type="date" id="walkinDate" required>
            </div>
            <div class="form-group">
              <label for="walkinTime">Time:</label>
              <select id="walkinTime" required>
                <option>09:00</option>
                <option>09:30</option>
                <option>10:00</option>
                <option>10:30</option>
                <option>11:00</option> <!-- add more time slots if needed, not sure sa time options -->
              </select>
            </div>
            <div class="form-group">
              <label for="walkinSeat">Seat:</label>
              <input type="number" id="walkinSeat" required min="1">
            </div>
            <div class="modal-actions">
              <button type="button" class="cancel-btn" onclick="closeWalkinModal()">Cancel</button>
              <button type="submit" class="save-btn">Create Reservation</button>
            </div>
          </form>
        </div>
      </div>
      
      <div class="backfooter">
        <a href="home.html">Back to Home Page</a>
      </div>
    </div>
  </div>
    <script src="js/data.js"></script>
    <script>
      //only allow technicians here
      
      const loggedUser = 
      JSON.parse(localStorage.getItem('loggedInUser')) ||
      JSON.parse(sessionStorage.getItem('loggedInUser'));
      
      if (!loggedUser || loggedUser.role !=="technician") {
        alert("Access denied. This is for technicians only.")
    window.location.href = "home.html";
  }
  
  const table = document.getElementById("techTable");
  const editModal = document.getElementById("editModal");
  const editForm = document.getElementById("editForm");
  let currentEditingReservation = null;
  
  
  // Populate table with all reservations
  reservations.forEach(r => {
    const user = users.find(u => u.id === r.userId);
    const lab = labs.find(l => l.id === r.labId);
    
    const row = table.insertRow();
    row.insertCell().textContent = user.name;
    row.insertCell().textContent = lab.name;
    row.insertCell().textContent = r.seat;
    row.insertCell().textContent = r.date;
    row.insertCell().textContent = r.time;
    row.insertCell().textContent = r.dateRequested || "N/A";
    
    const actionCell = row.insertCell();
    actionCell.innerHTML =
    `<button onclick="openEditModal(${r.id})">Edit</button>
     <button onclick="removeReservation(${r.id})">Remove</button>`;
    });
    
    // lab dropdown for the edit modal
    function populateLabDropdown() {
      const labSelect = document.getElementById("editLab");
      labSelect.innerHTML = '';
      labs.forEach(lab => {
        const option = document.createElement("option");
        option.value = lab.id;
        option.textContent = lab.name;
        labSelect.appendChild(option);
      });
    }
    
    // Open edit modal - technicians can edit any reservation
    function openEditModal(id) {
      currentEditingReservation = reservations.find(r => r.id === id);
      
      if (!currentEditingReservation) {
        alert("Reservation not found");
        return;
      }
      
      const user = users.find(u => u.id === currentEditingReservation.userId);
      
      populateLabDropdown();
      
  document.getElementById("editUser").value = user.name;
  document.getElementById("editLab").value = currentEditingReservation.labId;
  document.getElementById("editDate").value = currentEditingReservation.date;
  document.getElementById("editTime").value = currentEditingReservation.time;
  document.getElementById("editSeat").value = currentEditingReservation.seat;
  
  editModal.style.display = "block";
}

// close edit modal
function closeEditModal() {
  editModal.style.display = "none";
  currentEditingReservation = null;
  editForm.reset();
}

// handle form submission
editForm.addEventListener("submit", function(e) {
  e.preventDefault();
  
  if (!currentEditingReservation) return;
  
  const labId = parseInt(document.getElementById("editLab").value);
  const date = document.getElementById("editDate").value;
  const time = document.getElementById("editTime").value;
  const seat = parseInt(document.getElementById("editSeat").value);
  
  const isConflict = reservations.some(r => 
    r.labId === labId && 
    r.date === date && 
    r.time === time && 
    r.seat === seat && 
    r.id !== currentEditingReservation.id
  );

  if (isConflict) {
    alert("Error: This seat is already taken for the selected lab, date, and time.");
    return; 
  }

  // update reservation
  currentEditingReservation.labId = labId;
  currentEditingReservation.date = date;
  currentEditingReservation.time = time;
  currentEditingReservation.seat = seat;

  currentEditingReservation.dateRequested = new Date().toISOString().slice(0,16).replace('T',' ') + " (Edited)";


  saveReservations();
  closeEditModal();
  location.reload();
});

// Close modal when clicking outside of it
window.onclick = function(event) {
  if (event.target == editModal) {
    closeEditModal();
  }
}

function removeReservation(id) {
  if (confirm("Are you sure you want to remove this reservation?")) {
    reservations = reservations.filter(r => r.id !== id);
    saveReservations();
    location.reload();
  }
}
</script>

<script>
// walk-in reservation logic for technicians
const walkinModal = document.getElementById('walkinModal');
const walkinForm = document.getElementById('walkinForm');

function populateStudentsDropdown() {
  const sel = document.getElementById('walkinStudent');
  sel.innerHTML = '';
  
  // Only show users with role 'student'
  users.filter(u => u.role === 'student').forEach(u => {
    const opt = document.createElement('option');
    opt.value = u.id;
    opt.textContent = u.name;
    sel.appendChild(opt);
  });
}

function populateWalkinLabDropdown() {
  const sel = document.getElementById('walkinLab');
  sel.innerHTML = '';
  labs.forEach(l => {
    const opt = document.createElement('option');
    opt.value = l.id;
    opt.textContent = l.name;
    sel.appendChild(opt);
  });
}

function openWalkinModal() {
  populateStudentsDropdown();
  populateWalkinLabDropdown();
  limitWalkinDate();
  walkinModal.style.display = 'block';
}

function closeWalkinModal() {
  walkinModal.style.display = 'none';
  walkinForm.reset();
}

function isSlotTaken(labId, date, time, seat, excludeId = null) {
  return reservations.some(res => 
    res.labId === labId &&
    res.date === date &&
    res.time === time &&
    res.seat === seat &&
    res.id !== excludeId // Skip the current reservation if we are editing
  );
}

function limitWalkinDate() {
  const dateInput = document.getElementById('walkinDate');
  const today = new Date();
  const minDate = today.toISOString().split('T')[0];
  const maxDate = new Date(today);
  maxDate.setDate(maxDate.getDate() + 7);
  const maxDateString = maxDate.toISOString().split('T')[0];
  dateInput.setAttribute('min', minDate);
  dateInput.setAttribute('max', maxDateString);
  dateInput.value = minDate;
}

walkinForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const userId = parseInt(document.getElementById('walkinStudent').value);
  const labId = parseInt(document.getElementById('walkinLab').value);
  const date = document.getElementById('walkinDate').value;
  const time = document.getElementById('walkinTime').value;
  const seat = parseInt(document.getElementById('walkinSeat').value);

  // CHECK FOR OVERLAP
  if (isSlotTaken(labId, date, time, seat)) {
    alert("Error: This seat is already reserved for the selected lab, date, and time.");
    return; // Stop the function here
  }

  // create new id
  const newId = reservations.length ? Math.max(...reservations.map(r => r.id)) + 1 : 1;
  const newRes = {
    id: newId,
    userId: userId,
    labId: labId,
    seat: seat,
    date: date,
    time: time,
    anonymous: false,
    dateRequested: new Date().toISOString().slice(0,16).replace('T',' ')
  };

  reservations.push(newRes);
  saveReservations();
  closeWalkinModal();
  location.reload();
});

// close modal when clicking outside
window.addEventListener('click', function(event) {
  if (event.target === walkinModal) closeWalkinModal();
});
</script>

</body>
</html>

